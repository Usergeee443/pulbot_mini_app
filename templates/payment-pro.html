<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balans AI - Max tarif</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            color: #000000;
            overflow: visible; /* scrollbars ruxsat berish */
            -webkit-user-select: none; user-select: none;
            touch-action: pan-y; -webkit-text-size-adjust: 100%;
        }
        * { scrollbar-width: none; -ms-overflow-style: none; }
        *::-webkit-scrollbar { width: 0; height: 0; display: none; }

        .payment-container { width: 100%; min-height: 100vh; position: relative; display: flex; flex-direction: column; background: white; overflow-y: auto; }
        .gradient-overlay { position: absolute; top: 0; left: 0; right: 0; height: 35%; z-index: 0; transition: opacity 0.5s ease; background: linear-gradient(180deg, #7CB3FF 00%, #ffffff 100%); }
        .payment-header { text-align: center; padding: 20px 20px 20px; position: relative; z-index: 1; transition: opacity 0.4s ease; }
        .payment-header h1 { font-size: 64px; font-weight: 900; color: #FFFFFF; letter-spacing: -1px; }
        .payment-header p { font-size: 18px; color: white; line-height: 1.4; font-weight: 450; padding: 0 0px; }
        .content-area { padding: 0 20px 220px; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; position: relative; z-index: 1; flex: 1; }
        .features-list { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 16px; transition: opacity 0.4s ease; background: white; border: 0.5px solid #E0E0E0; border-radius: 24px; padding: 18px 18px; }
        .feature-item { display: flex; align-items: flex-start; gap: 12px; }
        .feature-icon { flex-shrink: 0; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; margin-top: 1px; }
        .feature-icon svg { width: 22px; height: 22px; stroke: #5A8EF4; stroke-width: 2.5; }
        .feature-text { font-size: 16px; color: rgba(0,0,0,0.85); line-height: 1.5; font-weight: 400; }
        .subscription-card { display: none; flex-direction: column; gap: 8px; margin-bottom: 20px; background: #ffffff; border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 20px; padding: 18px 20px; box-shadow: 0 8px 20px rgba(15, 23, 42, 0.05); }
        .subscription-card.show { display: flex; }
        .subscription-status { font-size: 12px; font-weight: 700; color: #16A34A; letter-spacing: 0.4px; text-transform: uppercase; }
        .subscription-name { font-size: 20px; font-weight: 700; color: #0F172A; letter-spacing: -0.3px; }
        .subscription-meta { display: flex; flex-direction: column; gap: 4px; font-size: 14px; color: rgba(15, 23, 42, 0.65); }
        .subscription-label { font-weight: 600; color: rgba(15, 23, 42, 0.6); }
        .subscription-value { font-weight: 600; color: #0F172A; }
        .success-banner { display: none; position: fixed; top: 14px; left: 50%; transform: translateX(-50%); background: #e8f8ee; color: #137a2a; border: 1px solid #c6eed3; padding: 10px 14px; border-radius: 12px; font-size: 14px; font-weight: 600; z-index: 2000; }
        .success-banner.show { display: inline-block; }

        .bottom-sheet-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .bottom-sheet-overlay.active { opacity: 1; pointer-events: all; }
        .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 24px 24px 0 0; padding: 24px 20px 40px; z-index: 1001; transform: translateY(100%); transition: transform 0.3s ease; max-height: 80vh; overflow-y: auto; }
        .bottom-sheet.active { transform: translateY(0); }
        .bottom-sheet * { scrollbar-width: none; -ms-overflow-style: none; }
        .bottom-sheet *::-webkit-scrollbar { display: none; }

        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .sheet-title { font-size: 20px; font-weight: 700; color: #000; }
        .sheet-close { background: none; border: none; font-size: 28px; color: rgba(0,0,0,0.5); cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }

        .duration-options { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }
        .duration-card { background: #F5F5F5; border: 2px solid transparent; border-radius: 16px; padding: 16px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .duration-card.selected { border-color: #5A8EF4; background: rgba(90,142,244,0.05); }
        .duration-left { display: flex; flex-direction: column; }
        .duration-label { font-size: 16px; font-weight: 600; color: #000; margin-bottom: 4px; }
        .duration-price { font-size: 14px; color: rgba(0,0,0,0.6); }
        .duration-badge { background: #27AE60; color: white; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 8px; }

        .action-btn { max-width: 400px; width: calc(100% - 40px); position: fixed; bottom: 55px; left: 50%; background: #000000; color: #ffffff; border: none; padding: 16px 20px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease; z-index: 99; border-radius: 100px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateX(-50%); }
        .action-btn:active { transform: translateX(-50%) scale(0.96); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .action-btn[disabled] { opacity: 0.6; cursor: not-allowed; }

        .legal-text { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); text-align: center; padding: 8px 40px; font-size: 11px; color: rgba(0,0,0,0.5); line-height: 1.4; z-index: 50; max-width: 400px; width: 100%; }
        .legal-text a { color: rgba(0,0,0,0.7); text-decoration: underline; }

        .sheet-action-btn { width: 100%; background: #000000; color: white; border: none; padding: 16px; border-radius: 100px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 24px; }
        .sheet-action-btn:active { opacity: 0.8; }
        .promo-section { display: flex; flex-direction: column; gap: 12px; margin: 20px 0 8px; }
        .promo-title { font-size: 14px; font-weight: 600; color: rgba(15, 23, 42, 0.6); text-transform: uppercase; letter-spacing: 0.4px; }
        .promo-input-group { display: flex; gap: 10px; align-items: center; }
        .promo-input-group input { flex: 1; border: 1px solid rgba(148, 163, 184, 0.35); border-radius: 14px; padding: 12px 14px; font-size: 15px; background: #F8FAFC; }
        .promo-input-group button { border: none; background: #1D4ED8; color: #fff; font-weight: 600; font-size: 14px; padding: 12px 16px; border-radius: 12px; cursor: pointer; transition: opacity 0.2s ease, transform 0.2s ease; }
        .promo-input-group button:active { transform: scale(0.97); }
        .promo-input-group button[disabled] { opacity: 0.6; cursor: not-allowed; transform: none; }
        .promo-feedback { font-size: 13px; min-height: 16px; color: rgba(15, 23, 42, 0.6); }
        .promo-feedback.error { color: #DC2626; }
        .promo-feedback.success { color: #16A34A; }
        .promo-remove-btn { align-self: flex-start; background: none; border: none; color: rgba(15, 23, 42, 0.6); font-size: 13px; font-weight: 600; cursor: pointer; text-decoration: underline; }
        .summary-section { display: flex; flex-direction: column; gap: 6px; margin-top: 16px; font-size: 15px; color: rgba(15, 23, 42, 0.75); }
        .summary-row { display: flex; justify-content: space-between; align-items: center; }
        .summary-row.discount { color: #DC2626; }
        .summary-row.total { font-size: 18px; font-weight: 700; color: #0F172A; margin-top: 4px; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay" style="position:fixed;inset:0;background:white;z-index:2000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;font-size:15px;color:rgba(15,23,42,0.65);">
        <div class="loading-spinner" style="width:42px;height:42px;border-radius:50%;border:3px solid rgba(148,163,184,0.35);border-top-color:#2563EB;animation:spin 0.9s linear infinite;"></div>
        <span>Ma'lumotlar yuklanmoqda...</span>
    </div>
    <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>

    <div class="payment-container" id="mainView" style="visibility:hidden;">
        <div class="gradient-overlay pro" id="gradientOverlay"></div>

        <div class="payment-header">
            <h1 id="tariffTitle">Max</h1>
            <p id="tariffDesc">AI yordamchisi bilan to'liq funksionallik va cheksiz imkoniyatlar.</p>
        </div>

        <div class="content-area">
            <div class="subscription-card" id="subscriptionSummary" style="display:none;">
                <div class="subscription-status">Max tarifi aktiv</div>
                <div class="subscription-name">Tarif ma'lumotlari</div>
                <div class="subscription-meta">
                    <span><span class="subscription-label">Sotib olingan sana:</span> <span class="subscription-value" id="summaryPurchasedAt">-</span></span>
                    <span><span class="subscription-label">Tugash sanasi:</span> <span class="subscription-value" id="summaryExpiry">-</span></span>
                    <span><span class="subscription-label">Qolgan kunlar:</span> <span class="subscription-value" id="summaryRemaining">-</span></span>
                    <span><span class="subscription-label">To'langan summa:</span> <span class="subscription-value" id="summaryAmount">-</span></span>
                </div>
            </div>
            <div class="subscription-card" id="subscriptionBenefits" style="display:none;">
                <div class="subscription-name">Tarif imkoniyatlari</div>
                <div class="subscription-meta" style="gap:8px;">
                    <span>ðŸ¤– AI bilan real vaqtda suhbat</span>
                    <span>ðŸ“Š Shaxsiy tahlil va moliyaviy maslahatlar</span>
                    <span>ðŸ“ˆ Qo'shimcha 5 ta kengaytirilgan grafiklar</span>
                    <span>ðŸ§¾ Oyiga cheksiz tranzaksiya va to'liq eksport</span>
                    <span>ðŸ”” Ogohlantirish va eslatmalarni avtomatik yuborish</span>
                </div>
            </div>
            <div class="features-list" id="featuresList">
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8.37988 12.0001L10.7899 14.4201L15.6199 9.58008" stroke="#5A8EF4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M10.7499 2.45031C11.4399 1.86031 12.5699 1.86031 13.2699 2.45031L14.8499 3.81031C15.1499 4.07031 15.7099 4.28031 16.1099 4.28031H17.8099C18.8699 4.28031 19.7399 5.15031 19.7399 6.21031V7.91031C19.7399 8.30031 19.9499 8.87031 20.2099 9.17031L21.5699 10.7503C22.1599 11.4403 22.1599 12.5703 21.5699 13.2703L20.2099 14.8503C19.9499 15.1503 19.7399 15.7103 19.7399 16.1103V17.8103C19.7399 18.8703 18.8699 19.7403 17.8099 19.7403H16.1099C15.7199 19.7403 15.1499 19.9503 14.8499 20.2103L13.2699 21.5703C12.5799 22.1603 11.4499 22.1603 10.7499 21.5703L9.16988 20.2103C8.86988 19.9503 8.30988 19.7403 7.90988 19.7403H6.17988C5.11988 19.7403 4.24988 18.8703 4.24988 17.8103V16.1003C4.24988 15.7103 4.03988 15.1503 3.78988 14.8503L2.43988 13.2603C1.85988 12.5703 1.85988 11.4503 2.43988 10.7603L3.78988 9.17031C4.03988 8.87031 4.24988 8.31031 4.24988 7.92031V6.20031C4.24988 5.14031 5.11988 4.27031 6.17988 4.27031H7.90988C8.29988 4.27031 8.86988 4.06031 9.16988 3.80031L10.7499 2.45031Z" stroke="#5A8EF4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="feature-text">Bu oddiy kuzatuv emas â€” bu siz bilan birga oÊ»ylaydigan, tahlil qiladigan va maslahat beradigan moliyaviy hamroh.</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">AI bilan real vaqtda suhbatlashish mumkin</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">Har bir xarajat va daromadga fikr bildiradi</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">Shaxsiy tahlil, maslahat va ogohlantirishlar</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">Plus paketlaridagi barcha imkoniyatlar + qoÊ»shimcha 5 ta grafik</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">Oyiga 10 baravar koÊ»p tranzaksiya limiti</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">Moliyaviy savollarga javob beruvchi AI maslahatchi</div>
                </div>
            </div>
        </div>

        <button class="action-btn" id="openSheetBtn">
            <span id="actionBtnText">49 990 so'm evaziga yangilanish</span>
        </button>

        <div class="legal-text">
            Yangilash orqali <a href="/terms">Foydalanish shartlari</a> va <a href="/privacy">Maxfiylik siyosati</a> ga rozilik bildirasiz.
        </div>
    </div>

    <div class="bottom-sheet-overlay" id="bottomSheetOverlay"></div>
    <div class="bottom-sheet" id="bottomSheet">
        <div class="sheet-header">
            <div class="sheet-title">Muddat tanlang</div>
            <button class="sheet-close" onclick="closeBottomSheet()">âœ•</button>
        </div>

        <div class="duration-options">
            <div class="duration-card selected" onclick="selectDuration(1, this)">
                <div class="duration-left">
                    <div class="duration-label">1 oy</div>
                    <div class="duration-price" id="price1Month">49 990 so'm</div>
                </div>
            </div>
            <div class="duration-card" onclick="selectDuration(12, this)">
                <div class="duration-left">
                    <div class="duration-label">12 oy</div>
                    <div class="duration-price" id="price12Month">539 892 so'm</div>
                </div>
                <div class="duration-badge">10% chegirma</div>
            </div>
        </div>

        <div class="promo-section">
            <div class="promo-title">Promokod</div>
            <div class="promo-input-group">
                <input type="text" id="promoInput" placeholder="Masalan, 50FRIEND50" autocomplete="off">
                <button id="promoApplyBtn">Qo'llash</button>
            </div>
            <div class="promo-feedback" id="promoFeedback"></div>
            <button class="promo-remove-btn" id="promoRemoveBtn" style="display:none;">Promokodni olib tashlash</button>
        </div>

        <div class="payment-methods">
            <div class="payment-section-title">To'lov usuli</div>
            <div class="payment-method-card click-payment">
                <div class="payment-method-name">Click</div>
                <div class="payment-method-check">âœ“</div>
            </div>
        </div>

        <div class="summary-section">
            <div class="summary-row">
                <span>Asl narx</span>
                <span id="summaryOriginalPrice">-</span>
            </div>
            <div class="summary-row discount" id="promoDiscountRow" style="display:none;">
                <span>Chegirma</span>
                <span id="promoDiscountValue">-</span>
            </div>
            <div class="summary-row total">
                <span>To'lov summasi</span>
                <span id="summaryFinalPrice">-</span>
            </div>
        </div>

        <button class="sheet-action-btn" id="payBtn" onclick="processPayment()">To'lash</button>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
            tg.disableVerticalSwipes();
        }

        const loadingOverlay = document.getElementById('loadingOverlay');
        const mainView = document.getElementById('mainView');
        const subscriptionSummary = document.getElementById('subscriptionSummary');
        const summaryPurchasedAt = document.getElementById('summaryPurchasedAt');
        const summaryExpiry = document.getElementById('summaryExpiry');
        const summaryRemaining = document.getElementById('summaryRemaining');
        const summaryAmount = document.getElementById('summaryAmount');
        const subscriptionBenefits = document.getElementById('subscriptionBenefits');
        const openSheetBtn = document.getElementById('openSheetBtn');
        const payBtn = document.getElementById('payBtn');
        const bottomSheetOverlay = document.getElementById('bottomSheetOverlay');
        const bottomSheet = document.getElementById('bottomSheet');
        const sheetClose = bottomSheet.querySelector('.sheet-close');
        const featuresList = document.getElementById('featuresList');
const promoInput = document.getElementById('promoInput');
const promoApplyBtn = document.getElementById('promoApplyBtn');
const promoFeedback = document.getElementById('promoFeedback');
const promoRemoveBtn = document.getElementById('promoRemoveBtn');
const summaryOriginalPrice = document.getElementById('summaryOriginalPrice');
const summaryFinalPrice = document.getElementById('summaryFinalPrice');
const promoDiscountRow = document.getElementById('promoDiscountRow');
const promoDiscountValue = document.getElementById('promoDiscountValue');

        let currentDuration = 1;
        let userId = null;
        let currentTariff = 'Bepul';
        let currentExpiry = null;
        let lastPayment = null;
let appliedPromo = null;
const monthlyPrice = 49990;
const durationPrices = {
    1: monthlyPrice,
    12: Math.round(monthlyPrice * 12 * 0.9),
};

        function hideLoading() {
            loadingOverlay.style.display = 'none';
            mainView.style.visibility = 'visible';
        }

        function formatDate(isoString) {
            if (!isoString) return 'Avtomatik yangilanadi';
            try {
                const date = new Date(isoString);
                return date.toLocaleDateString('uz-UZ', { year: 'numeric', month: 'long', day: 'numeric' });
            } catch (e) {
                return isoString;
            }
        }

        function openBottomSheet() {
            hapticFeedback();
    updateSummary();
            if (bottomSheetOverlay) bottomSheetOverlay.classList.add('active');
            if (bottomSheet) bottomSheet.classList.add('active');
        }

        function closeBottomSheet() {
            hapticFeedback();
            if (bottomSheetOverlay) bottomSheetOverlay.classList.remove('active');
            if (bottomSheet) bottomSheet.classList.remove('active');
        }

        function hapticFeedback() {
            if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }

function formatPriceValue(amount) {
    const numeric = Number(amount) || 0;
    return numeric.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
}

function getBasePrice(months = currentDuration) {
    return durationPrices[months] || durationPrices[1];
}

function updateDurationLabels() {
    const price1El = document.getElementById('price1Month');
    const price12El = document.getElementById('price12Month');
    if (price1El) {
        price1El.textContent = `${formatPriceValue(durationPrices[1])} so'm`;
    }
    if (price12El) {
        price12El.textContent = `${formatPriceValue(durationPrices[12])} so'm`;
    }
}

function showPromoFeedback(message, isError) {
    if (!promoFeedback) return;
    promoFeedback.textContent = message;
    promoFeedback.className = 'promo-feedback';
    if (message) {
        promoFeedback.classList.add(isError ? 'error' : 'success');
    }
}

function clearPromo(options = {}) {
    const keepInput = options.keepInput || false;
    appliedPromo = null;
    if (!keepInput && promoInput) {
        promoInput.value = '';
    }
    if (promoRemoveBtn) {
        promoRemoveBtn.style.display = 'none';
    }
    showPromoFeedback('', false);
    if (promoDiscountRow) {
        promoDiscountRow.style.display = 'none';
    }
    updateSummary();
}

function updateSummary() {
    const basePrice = getBasePrice();
    const finalPrice = appliedPromo ? appliedPromo.final_amount : basePrice;
    const discountAmount = appliedPromo ? appliedPromo.discount_amount : 0;
    if (summaryOriginalPrice) {
        summaryOriginalPrice.textContent = `${formatPriceValue(basePrice)} so'm`;
    }
    if (promoDiscountRow) {
        if (discountAmount > 0) {
            promoDiscountRow.style.display = 'flex';
            if (promoDiscountValue) {
                promoDiscountValue.textContent = `- ${formatPriceValue(discountAmount)} so'm`;
            }
        } else {
            promoDiscountRow.style.display = 'none';
        }
    }
    if (summaryFinalPrice) {
        summaryFinalPrice.textContent = `${formatPriceValue(finalPrice)} so'm`;
    }
    const actionBtnText = document.getElementById('actionBtnText');
    if (actionBtnText) {
        actionBtnText.textContent = `${formatPriceValue(finalPrice)} so'm evaziga yangilanish`;
    }
    if (payBtn) {
        payBtn.textContent = `${formatPriceValue(finalPrice)} so'mga to'lash`;
    }
}

        function selectDuration(months, element) {
            hapticFeedback();
            currentDuration = months;
            document.querySelectorAll('.duration-card').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');
    clearPromo({ keepInput: true });
    updateActionButton();
        }

        function updateActionButton() {
    updateDurationLabels();
    updateSummary();
        }

async function applyPromo() {
    if (!promoInput || !promoApplyBtn) return;
    const code = promoInput.value.trim();
    if (!code) {
        showPromoFeedback('Iltimos, promokodni kiriting.', true);
        hapticFeedback();
        return;
    }
    const basePrice = getBasePrice();
    promoApplyBtn.disabled = true;
    promoApplyBtn.textContent = 'Tekshirilmoqda...';
    showPromoFeedback('', false);
    try {
        const response = await fetch('/api/promocode/validate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                code,
                plan_type: 'PRO',
                amount: basePrice,
            }),
        });
        const json = await response.json();
        if (!response.ok || !json?.success) {
            throw new Error(json?.message || 'Promokod topilmadi.');
        }
        const data = json.data || {};
        appliedPromo = {
            code: data.code,
            discount_percent: data.discount_percent,
            discount_amount: data.discount_amount,
            final_amount: data.final_amount,
        };
        if (promoRemoveBtn) {
            promoRemoveBtn.style.display = 'inline-flex';
        }
        showPromoFeedback(`${appliedPromo.discount_percent}% chegirma qo'llandi.`, false);
        updateSummary();
        hapticFeedback();
    } catch (err) {
        appliedPromo = null;
        showPromoFeedback(err.message || 'Promokodni qo\'llab bo\'lmadi.', true);
        if (promoRemoveBtn) {
            promoRemoveBtn.style.display = 'none';
        }
        updateSummary();
    } finally {
        promoApplyBtn.disabled = false;
        promoApplyBtn.textContent = "Qo'llash";
    }
}

function removePromo() {
    clearPromo({ keepInput: true });
    if (promoInput) {
        promoInput.focus();
    }
    hapticFeedback();
}

        async function resolveUserId() {
            if (tg?.initDataUnsafe?.user?.id) return tg.initDataUnsafe.user.id;
            if (tg?.initData) {
                try {
                    const params = new URLSearchParams(tg.initData);
                    const userStr = params.get('user');
                    if (userStr) {
                        const parsed = JSON.parse(decodeURIComponent(userStr));
                        if (parsed?.id) return parsed.id;
                    }
                } catch (e) {
                    console.error('initData parse error:', e);
                }
            }
            return null;
        }

        function renderSubscription() {
            const isActive = currentTariff === 'PRO' || currentTariff === 'MAX';
            if (isActive) {
                const paidDisplay = lastPayment?.paid_at ? formatDate(lastPayment.paid_at) : 'â€”';
                const amountDisplay = lastPayment?.amount ? `${lastPayment.amount.toLocaleString('uz-UZ')} so'm` : 'â€”';
                const expiryDisplay = formatDate(currentExpiry);
                let remainingDays = 'â€”';
                if (currentExpiry) {
                    try {
                        const diffMs = new Date(currentExpiry) - new Date();
                        if (!Number.isNaN(diffMs)) {
                            const days = Math.max(0, Math.ceil(diffMs / (1000 * 60 * 60 * 24)));
                            remainingDays = `${days} kun`;
                        }
                    } catch (_) {}
                }
                summaryPurchasedAt.textContent = paidDisplay;
                summaryExpiry.textContent = expiryDisplay;
                summaryRemaining.textContent = remainingDays;
                summaryAmount.textContent = amountDisplay;
                subscriptionSummary.style.display = 'flex';
                subscriptionBenefits.style.display = 'flex';
                if (featuresList) featuresList.style.display = 'none';
                if (openSheetBtn) openSheetBtn.style.display = 'none';
                if (payBtn) payBtn.style.display = 'none';
                closeBottomSheet();
            } else {
                subscriptionSummary.style.display = 'none';
                subscriptionBenefits.style.display = 'none';
                if (featuresList) featuresList.style.display = 'flex';
                if (openSheetBtn) openSheetBtn.style.display = 'block';
                if (payBtn) payBtn.style.display = 'block';
            }
        }

        async function loadTariff() {
            try {
                const response = await fetch(`/api/user/tariff/${userId}`);
                if (!response.ok) return;
                const json = await response.json();
                currentTariff = (json?.data?.tariff || 'Bepul').toString().toUpperCase();
                currentExpiry = json?.data?.expires_at || null;
                lastPayment = json?.data?.last_payment || null;
                renderSubscription();
            } catch (e) {
                console.error('Tariff load error:', e);
            }
        }

        async function processPayment() {
            hapticFeedback();
            if (!userId) {
                if (tg) tg.showAlert('âŒ User ID topilmadi');
                else alert('âŒ User ID topilmadi');
                return;
            }
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/payment-pro';
            form.appendChild(createHiddenInput('user_id', userId));
            form.appendChild(createHiddenInput('months', currentDuration.toString()));
    form.appendChild(createHiddenInput('payment_method', 'click'));
    if (appliedPromo?.code) {
        form.appendChild(createHiddenInput('promo_code', appliedPromo.code));
    }
            document.body.appendChild(form);
            form.submit();
        }

        function createHiddenInput(name, value) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            return input;
        }

        async function init() {
            updateActionButton();
            userId = await resolveUserId();
            if (!userId) {
                hideLoading();
                if (tg?.showAlert) {
                    tg.showAlert('Telegram foydalanuvchisini aniqlashning imkoni bo\'lmadi.');
                }
                return;
            }
            await loadTariff();
            hideLoading();
        }

        if (openSheetBtn) openSheetBtn.addEventListener('click', openBottomSheet);
        if (bottomSheetOverlay) bottomSheetOverlay.addEventListener('click', closeBottomSheet);
        if (sheetClose) sheetClose.addEventListener('click', closeBottomSheet);
        if (payBtn) payBtn.addEventListener('click', processPayment);
if (promoApplyBtn) promoApplyBtn.addEventListener('click', applyPromo);
if (promoRemoveBtn) promoRemoveBtn.addEventListener('click', removePromo);
if (promoInput) {
    promoInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            applyPromo();
        }
    });
}

        init();
    </script>
</body>
</html>
