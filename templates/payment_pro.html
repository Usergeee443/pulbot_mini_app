<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balans AI - PRO Obuna</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            color: #000000;
            overflow: hidden; /* scrollbars yo'q */
            -webkit-user-select: none; user-select: none;
            touch-action: pan-y; -webkit-text-size-adjust: 100%;
        }
        /* Scrollbarni yashirish (iOS/Android/WebKit) */
        * { scrollbar-width: none; -ms-overflow-style: none; }
        *::-webkit-scrollbar { width: 0; height: 0; display: none; }

        .payment-container { width: 100%; min-height: 100vh; position: relative; display: flex; flex-direction: column; background: white; }
        .gradient-overlay { position: absolute; top: 0; left: 0; right: 0; height: 35%; z-index: 0; transition: opacity 0.5s ease; background: linear-gradient(180deg, #7CB3FF 00%, #ffffff 100%); }
        .payment-header { text-align: center; padding: 60px 20px 40px; position: relative; z-index: 1; transition: opacity 0.4s ease; }
        .payment-header h1 { font-size: 64px; font-weight: 900; color: #FFFFFF; letter-spacing: -1px; }
        .payment-header p { font-size: 18px; color: white; line-height: 1.4; font-weight: 450; padding: 0 20px; }
        .content-area { padding: 0 20px 220px; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; position: relative; z-index: 1; flex: 1; }
        .features-list { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 16px; transition: opacity 0.4s ease; background: white; border: 0.5px solid #E0E0E0; border-radius: 24px; padding: 18px 18px; }
        .feature-item { display: flex; align-items: flex-start; gap: 12px; }
        .feature-icon { flex-shrink: 0; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; margin-top: 1px; }
        .feature-icon svg { width: 22px; height: 22px; stroke: #5A8EF4; stroke-width: 2.5; }
        .feature-text { font-size: 16px; color: rgba(0,0,0,0.85); line-height: 1.5; font-weight: 400; }

        /* Success banner */
        .success-banner { display: none; position: fixed; top: 14px; left: 50%; transform: translateX(-50%); background: #e8f8ee; color: #137a2a; border: 1px solid #c6eed3; padding: 10px 14px; border-radius: 12px; font-size: 14px; font-weight: 600; z-index: 2000; }
        .success-banner.show { display: inline-block; }

        /* Bottom Sheet */
        .bottom-sheet-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .bottom-sheet-overlay.active { opacity: 1; pointer-events: all; }
        .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 24px 24px 0 0; padding: 24px 20px 40px; z-index: 1001; transform: translateY(100%); transition: transform 0.3s ease; max-height: 80vh; overflow-y: auto; }
        .bottom-sheet.active { transform: translateY(0); }
        .bottom-sheet * { scrollbar-width: none; -ms-overflow-style: none; }
        .bottom-sheet *::-webkit-scrollbar { display: none; }

        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .sheet-title { font-size: 20px; font-weight: 700; color: #000; }
        .sheet-close { background: none; border: none; font-size: 28px; color: rgba(0,0,0,0.5); cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }

        .duration-options { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }
        .duration-card { background: #F5F5F5; border: 2px solid transparent; border-radius: 16px; padding: 16px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .duration-card.selected { border-color: #5A8EF4; background: rgba(90,142,244,0.05); }
        .duration-left { display: flex; flex-direction: column; }
        .duration-label { font-size: 16px; font-weight: 600; color: #000; margin-bottom: 4px; }
        .duration-price { font-size: 14px; color: rgba(0,0,0,0.6); }
        .duration-badge { background: #27AE60; color: white; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 8px; }

        .action-btn { max-width: 400px; width: calc(100% - 40px); position: fixed; bottom: 55px; left: 50%; background: #000000; color: #ffffff; border: none; padding: 16px 20px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease; z-index: 99; border-radius: 100px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateX(-50%); }
        .action-btn:active { transform: translateX(-50%) scale(0.96); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .action-btn[disabled] { opacity: 0.6; cursor: not-allowed; }

        .legal-text { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); text-align: center; padding: 8px 40px; font-size: 11px; color: rgba(0,0,0,0.5); line-height: 1.4; z-index: 50; max-width: 400px; width: 100%; }
        .legal-text a { color: rgba(0,0,0,0.7); text-decoration: underline; }

        .sheet-action-btn { width: 100%; background: #000000; color: white; border: none; padding: 16px; border-radius: 100px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 24px; }
        .sheet-action-btn:active { opacity: 0.8; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="success-banner" id="successBanner">✅ Sizda PRO obuna faol. Qayta to'lov kerak emas.</div>

    <div class="payment-container" id="mainView">
        <div class="gradient-overlay pro" id="gradientOverlay"></div>

        <div class="payment-header">
            <h1 id="tariffTitle">Pro</h1>
            <p id="tariffDesc">AI bilan yanada chuqurroq nazorat va tahlil.</p>
        </div>

        <div class="content-area">
            <div class="features-list" id="featuresList">
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">Eng Aqilliroq AI</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">Oyiga cheksiz tranzaksiya</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">Ovozli xabar orqali tranzaksiya</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">qo'shicha 10 ta tahlil</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">Realtaym ovozli AI moliyaviy suhbat imkoniyati</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">AI bilan chat</div>
                </div>
            </div>
        </div>

        <button class="action-btn" id="openSheetBtn" onclick="openBottomSheet()">
            <span id="actionBtnText">2 000 so'm evaziga yangilanish</span>
        </button>

        <div class="legal-text">
            Yangilash orqali <a href="/terms">Foydalanish shartlari</a> va <a href="/privacy">Maxfiylik siyosati</a> ga rozilik bildirasiz.
        </div>
    </div>

    <!-- Bottom Sheet -->
    <div class="bottom-sheet-overlay" id="bottomSheetOverlay" onclick="closeBottomSheet()"></div>
    <div class="bottom-sheet" id="bottomSheet">
        <div class="sheet-header">
            <div class="sheet-title">Muddat tanlang</div>
            <button class="sheet-close" onclick="closeBottomSheet()">✕</button>
        </div>

        <div class="duration-options">
            <div class="duration-card selected" onclick="selectDuration(1, this)">
                <div class="duration-left">
                    <div class="duration-label">1 oy</div>
                    <div class="duration-price" id="price1Month">2 000 so'm</div>
                </div>
            </div>
            <div class="duration-card" onclick="selectDuration(12, this)">
                <div class="duration-left">
                    <div class="duration-label">12 oy</div>
                    <div class="duration-price" id="price12Month">21 600 so'm</div>
                </div>
                <div class="duration-badge">10% chegirma</div>
            </div>
        </div>

        <div class="payment-methods">
            <div class="payment-section-title">To'lov usuli</div>
            <div class="payment-method-card click-payment" onclick="handleClickPayment()">
                <div class="payment-method-name">Click</div>
                <div class="payment-method-check">✓</div>
            </div>
        </div>

        <button class="sheet-action-btn" id="payBtn" onclick="processPayment()">To'lash</button>
    </div>

    <script>
        // Telegram WebApp init
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
            tg.disableVerticalSwipes();
        }

        let currentDuration = 1;
        function openBottomSheet() {
            hapticFeedback();
            document.getElementById('bottomSheetOverlay').classList.add('active');
            document.getElementById('bottomSheet').classList.add('active');
        }
        function closeBottomSheet() {
            hapticFeedback();
            document.getElementById('bottomSheetOverlay').classList.remove('active');
            document.getElementById('bottomSheet').classList.remove('active');
        }
        function hapticFeedback() {
            if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }
        function selectDuration(months, element) {
            hapticFeedback();
            currentDuration = months;
            document.querySelectorAll('.duration-card').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');
            updateActionButton();
        }
        function updateActionButton() {
            const price = currentDuration === 1 ? 2000 : Math.round(2000 * 12 * 0.9);
            document.getElementById('actionBtnText').textContent = `${price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} so'm evaziga yangilanish`;
            document.getElementById('price1Month').textContent = `2 000 so'm`;
            document.getElementById('price12Month').textContent = `21 600 so'm`;
        }

        // Subscription lock: agar PRO/PLUS aktiv bo'lsa — to'lashni bloklash
        async function checkSubscriptionAndLock() {
            try {
                let userId = null;
                if (tg?.initDataUnsafe?.user?.id) userId = tg.initDataUnsafe.user.id;
                else if (tg?.initData) {
                    const params = new URLSearchParams(tg.initData);
                    const userStr = params.get('user');
                    if (userStr) userId = JSON.parse(decodeURIComponent(userStr)).id;
                }
                if (!userId) return;
                const res = await fetch(`/api/user/tariff/${userId}`);
                const json = await res.json();
                const code = (json?.data?.tariff || 'Bepul').toString().toUpperCase();
                if (code === 'PLUS' || code === 'PRO') {
                    // show banner and disable payment
                    document.getElementById('successBanner').classList.add('show');
                    document.getElementById('openSheetBtn').setAttribute('disabled', 'true');
                    document.getElementById('payBtn').setAttribute('disabled', 'true');
                }
            } catch (e) { console.log('check sub error', e); }
        }

        async function processPayment() {
            hapticFeedback();
            let userId = null;
            if (tg?.initDataUnsafe?.user?.id) userId = tg.initDataUnsafe.user.id;
            else if (tg?.initData) {
                try {
                    const params = new URLSearchParams(tg.initData);
                    const userStr = params.get('user');
                    if (userStr) userId = JSON.parse(decodeURIComponent(userStr)).id;
                } catch {}
            }
            if (!userId) { if (tg) tg.showAlert('❌ User ID topilmadi'); else alert('❌ User ID topilmadi'); return; }

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/payment-pro';
            form.appendChild(createHiddenInput('user_id', userId));
            form.appendChild(createHiddenInput('months', currentDuration.toString()));
            document.body.appendChild(form);
            form.submit();
        }
        function createHiddenInput(name, value) { const i = document.createElement('input'); i.type='hidden'; i.name=name; i.value=value; return i; }

        window.addEventListener('DOMContentLoaded', () => { updateActionButton(); checkSubscriptionAndLock(); });
    </script>
</body>
</html>
