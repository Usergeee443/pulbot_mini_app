<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balans AI - Tarif</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            color: #000000;
            overflow: visible; /* scrollbars ruxsat berish */
            -webkit-user-select: none;
            user-select: none;
            touch-action: pan-y;
            -webkit-text-size-adjust: 100%;
        }

        /* Scrollbarni yashirish (iOS/Android/WebKit) */
        * { scrollbar-width: none; -ms-overflow-style: none; }
        *::-webkit-scrollbar { width: 0; height: 0; display: none; }

        .payment-container {
            width: 100%;
            min-height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
            background: white;
            overflow-y: auto;
        }

        /* Gradient overlay - faqat tepa 40% */
        .gradient-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 35%;
            z-index: 0;
            transition: opacity 0.5s ease;
            background: linear-gradient(180deg, #7CB3FF 00%, #ffffff 100%);
        }

        /* Header */
        .payment-header {
            text-align: center;
            padding: 20px 20px 20px;
            position: relative;
            z-index: 1;
            transition: opacity 0.4s ease;
        }

        .payment-header h1 {
            font-size: 64px;
            font-weight: 900;
            color: #FFFFFF;
            letter-spacing: -1px;
        }

        .payment-header p {
            font-size: 18px;
            color: white;
            line-height: 1.4;
            font-weight: 450;
            padding: 0 20px;
        }

        /* Content Area */
        .content-area {
            padding: 0 20px 220px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            position: relative;
            z-index: 1;
            flex: 1;
        }

        /* Feature list - card with border, qoq o'rtada */
        .features-list {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            transition: opacity 0.4s ease;
            background: white;
            border: 0.5px solid #E0E0E0;
            border-radius: 24px;
            padding: 18px 18px;
        }

        .feature-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .feature-icon {
            flex-shrink: 0;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 1px;
        }

        .feature-icon svg {
            width: 22px;
            height: 22px;
            stroke: #5A8EF4;
            stroke-width: 2.5;
        }

        .feature-text {
            font-size: 16px;
            color: rgba(0, 0, 0, 0.85);
            line-height: 1.5;
            font-weight: 400;
        }

        /* Price selection buttons - rasmdagidek slider effect */
        .price-selector {
            position: fixed;
            bottom: 120px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: center;
            z-index: 98;
        }

        .price-selector-wrapper {
            background: #F5F5F5;
            border-radius: 16px;
            display: flex;
            gap: 4px;
            position: relative;
            width: 100%;
            max-width: 400px;
        }

        .price-slider {
            position: absolute;
            top: 0px;
            bottom: 0px;
            border: solid 2px #000000;
            border-radius: 16px;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
        }

        .price-btn {
            background: transparent;
            border: none;
            width: 100%;
            border-radius: 16px;
            padding: 12px 12px;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }

        .price-btn:active {
            transform: scale(0.98);
        }

        .price-label {
            font-size: 16px;
            font-weight: 900;
            color: rgba(0, 0, 0, 0.4);
            display: block;
            margin-bottom: 2px;
            transition: color 0.35s ease;
        }

        .price-btn.selected .price-label {
            color: #000;
        }

        .price-amount {
            font-size: 12px;
            color: rgba(0, 0, 0, 0.3);
            display: block;
            transition: color 0.35s ease;
        }

        .price-btn.selected .price-amount {
            color: rgba(0, 0, 0, 0.80);
        }

        /* Button - 100% radius + press effect */
        .action-btn {
            max-width: 400px;
            width: calc(100% - 40px); /* 40px = left 20px + right 20px */
            position: fixed;
            bottom: 55px;
            left: 50%;
            background: #000000;
            color: #ffffff;
            border: none;
            padding: 16px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            z-index: 99;
            border-radius: 100px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(-50%);
        }

        .action-btn:active {
            transform: translateX(-50%) scale(0.96);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Legal text - tugma ostida */
        .legal-text {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            padding: 8px 40px;
            font-size: 11px;
            color: rgba(0, 0, 0, 0.5);
            line-height: 1.4;
            z-index: 50;
            max-width: 400px;
            width: 100%;
        }

        .legal-text a {
            color: rgba(0, 0, 0, 0.7);
            text-decoration: underline;
        }

        /* Bottom Sheet */
        .bottom-sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .bottom-sheet-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 24px 24px 0 0;
            padding: 24px 20px 40px;
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
        }

        .bottom-sheet.active {
            transform: translateY(0);
        }

        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .sheet-title {
            font-size: 20px;
            font-weight: 700;
            color: #000;
        }

        .sheet-close {
            background: none;
            border: none;
            font-size: 28px;
            color: rgba(0, 0, 0, 0.5);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Duration options */
        .duration-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .duration-card {
            background: #F5F5F5;
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .duration-card:active {
            transform: scale(0.98);
        }

        .duration-card.selected {
            border-color: #5A8EF4;
            background: rgba(90, 142, 244, 0.05);
        }

        .duration-left {
            display: flex;
            flex-direction: column;
        }

        .duration-label {
            font-size: 16px;
            font-weight: 600;
            color: #000;
            margin-bottom: 4px;
        }

        .duration-price {
            font-size: 14px;
            color: rgba(0, 0, 0, 0.6);
        }

        .duration-badge {
            background: #27AE60;
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 8px;
        }

        /* Payment methods */
        .payment-methods {
            margin-top: 24px;
        }

        .payment-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #000;
            margin-bottom: 12px;
        }

        .payment-method-card {
            background: #F5F5F5;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }

        .coming-soon-text {
            font-size: 15px;
            color: rgba(0, 0, 0, 0.5);
            font-weight: 500;
        }

        .sheet-action-btn {
            width: 100%;
            background: #000000;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 100px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 24px;
        }

        .sheet-action-btn:active {
            opacity: 0.8;
        }

        .hidden {
            display: none;
        }

        /* Success banner */
        .success-banner { display: none; position: fixed; top: 14px; left: 50%; transform: translateX(-50%); background: #e8f8ee; color: #137a2a; border: 1px solid #c6eed3; padding: 10px 14px; border-radius: 12px; font-size: 14px; font-weight: 600; z-index: 2000; }
        .success-banner.show { display: inline-block; }
        /* Loading overlay */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .loading-overlay.hidden { display: none; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #000; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <p style="color: #666; font-size: 15px; margin-top: 16px;">Ma'lumotlar yuklanmoqda...</p>
        </div>
    </div>

    <!-- Plus Tarif View -->
    <div class="success-banner" id="successBanner">✅ Obunangiz faol. Qayta to'lov kerak emas.</div>

    <div class="payment-container" id="mainView">
        <!-- Gradient overlay -->
        <div class="gradient-overlay plus" id="gradientOverlay"></div>

        <div class="payment-header">
            <h1 id="tariffTitle">Plus</h1>
            <p id="tariffDesc">Tezroq, aqlliroq va qulayroq balans yuritish.</p>
        </div>

        <div class="content-area">
            <div class="features-list" id="featuresList">
                <!-- Plus features -->
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">Oyiga 750 ta matn + 250 ta ovozli kiritish.</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">Ovozli xabarni avtomatik tushunadi</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">Tranzaksiyalarni kategoriyalarga ajratadi</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">Kunlik, haftalik va oylik tahlillar</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">Xarajatlar bo‘yicha 5 ta grafik</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">AI tahlili va qisqa moliyaviy fikrlar</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="feature-text">Avtomatik eslatmalar</div>
                </div>
            </div>
        </div>

        <div class="price-selector">
            <div class="price-selector-wrapper">
                <div class="price-slider" id="priceSlider"></div>
                <div class="price-btn selected" onclick="selectPrice('plus', this)">
                    <div class="price-label">Plus</div>
                    <div class="price-amount">19 000 so'm/oy</div>
                </div>
                <div class="price-btn" onclick="selectPrice('pro', this)">
                    <div class="price-label">Pro</div>
                    <div class="price-amount">49 990 so'm/oy</div>
                </div>
            </div>
        </div>

        <button class="action-btn" id="openSheetBtn" onclick="openBottomSheet()">
                    <span id="actionBtnText">19 990 so'm evaziga yangilanish</span>
        </button>

        <div class="legal-text">
            Yangilash orqali <a href="/terms">Foydalanish shartlari</a> va <a href="/privacy">Maxfiylik siyosati</a> ga rozilik bildirasiz.
        </div>
    </div>

    <!-- Bottom Sheet -->
    <div class="bottom-sheet-overlay" id="bottomSheetOverlay" onclick="closeBottomSheet()"></div>
    <div class="bottom-sheet" id="bottomSheet">
        <div class="sheet-header">
            <div class="sheet-title">Muddat tanlang</div>
            <button class="sheet-close" onclick="closeBottomSheet()">✕</button>
        </div>

        <div class="duration-options">
            <div class="duration-card selected" onclick="selectDuration(1, this)">
                <div class="duration-left">
                    <div class="duration-label">1 oy</div>
                    <div class="duration-price" id="price1Month">19 990 so'm</div>
                </div>
            </div>
            <div class="duration-card" onclick="selectDuration(12, this)">
                <div class="duration-left">
                    <div class="duration-label">12 oy</div>
                    <div class="duration-price" id="price12Month">215 892 so'm</div>
                </div>
                <div class="duration-badge">10% chegirma</div>
            </div>
        </div>

        <div class="payment-methods">
            <div class="payment-section-title">To'lov usuli</div>
            <div class="payment-method-card click-payment" onclick="handleClickPayment()">
                <div class="payment-method-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="payment-method-name">Click</div>
                <div class="payment-method-check">✓</div>
            </div>
        </div>

        <button class="sheet-action-btn" id="payBtn" onclick="processPayment()">
            To'lash
        </button>
    </div>

    <script>
        // Telegram WebApp init
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
            // Pull-to-close funksiyasini o'chirish
            tg.disableVerticalSwipes();
        }

        // Check tariff and redirect
        async function checkAndRedirect() {
            try {
                let userId = null;
                if (tg?.initDataUnsafe?.user?.id) userId = tg.initDataUnsafe.user.id;
                else if (tg?.initData) {
                    const params = new URLSearchParams(tg.initData);
                    const userStr = params.get('user');
                    if (userStr) userId = JSON.parse(decodeURIComponent(userStr)).id;
                }
                
                if (!userId) {
                    // User ID topilmasa, loading yashirish
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    return;
                }

                const res = await fetch(`/api/user/tariff/${userId}`);
                const json = await res.json();
                const code = (json?.data?.tariff || 'Bepul').toString().toUpperCase();
                
                if (code === 'PLUS') {
                    // Plus bo'lsa PRO sahifasiga yo'naltir
                    window.location.href = '/payment-pro';
                    return;
                } else if (code === 'PRO') {
                    // PRO bo'lsa block sahifa
                    renderBlockedPage(code);
                    return;
                }
                
                // Bepul bo'lsa yoki hato bo'lsa, loading yashirish
                document.getElementById('loadingOverlay').classList.add('hidden');
            } catch (e) {
                console.error('Check error:', e);
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        function renderBlockedPage(code) {
            document.body.innerHTML = `
                <div style="font-family: -apple-system, sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background: white;">
                    <div style="text-align: center; max-width: 320px;">
                        <div style="width: 80px; height: 80px; background: #f3f3f3; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                            <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="#666" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h1 style="font-size: 24px; font-weight: 700; color: #111827; margin-bottom: 8px;">${code} obuna faol</h1>
                        <p style="font-size: 15px; color: #6B7280; line-height: 1.5; margin-bottom: 32px;">Sizda allaqachon Premium obuna faol. Qayta to'lov shart emas.</p>
                        <button onclick="if (window.Telegram?.WebApp) { window.Telegram.WebApp.close(); } else { window.close(); }" style="width: 100%; background: #000; color: white; border: none; padding: 16px; border-radius: 100px; font-size: 16px; font-weight: 600; cursor: pointer;">Yopish</button>
                    </div>
                </div>
            `;
        }

        // Boshlanishida tekshir
        checkAndRedirect();

        function hapticFeedback() {
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }

        let currentTariff = 'plus';
        let currentDuration = 1;

        const tariffData = {
            plus: {
                title: 'Plus',
                desc: 'Tezroq, aqlliroq va qulayroq balans yuritish.',
                monthly: 19990,  // PRODUCTION: 19990 so'm
                features: [
                    'Oyiga 750 ta matn + 250 ta ovozli kiritish.',
                    'Ovozli xabarni avtomatik tushunadi',
                    'Tranzaksiyalarni kategoriyalarga ajratadi',
                    'Kunlik, haftalik va oylik tahlillar',
                    'Xarajatlar bo‘yicha 5 ta grafik',
                    'AI tahlili va qisqa moliyaviy fikrlar',
                    'Avtomatik eslatmalar'
                ],
                gradient: 'plus'
            },
            pro: {
                title: 'Pro',
                desc: 'AI bilan yanada chuqurroq nazorat va tahlil.',
                monthly: 49990,  // PRODUCTION: 49990 so'm
                features: [
                    'Bu oddiy kuzatuv emas — bu siz bilan birga o‘ylaydigan, tahlil qiladigan va maslahat beradigan moliyaviy hamroh.',
                    'AI bilan real vaqtda suhbatlashish mumkin',
                    'Har bir xarajat va daromadga fikr bildiradi',
                    'Shaxsiy tahlil, maslahat va ogohlantirishlar',
                    'Plus’dagi barcha imkoniyatlar + qo‘shimcha 5 ta grafik',
                    'Oyiga 10 baravar ko‘p tranzaksiya limiti',
                    'Moliyaviy savollarga javob beruvchi AI maslahatchi'
                ],
                gradient: 'pro'
            }
        };

        function selectPrice(tariff, element) {
            hapticFeedback();
            if (currentTariff === tariff) return; // Agar bir xil bo'lsa animatsiya qilmaydi
            
            currentTariff = tariff;

            // Update buttons
            document.querySelectorAll('.price-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            element.classList.add('selected');

            // Animate slider
            const slider = document.getElementById('priceSlider');
            const btnRect = element.getBoundingClientRect();
            const wrapperRect = element.parentElement.getBoundingClientRect();
            const offsetLeft = btnRect.left - wrapperRect.left;
            
            slider.style.left = offsetLeft + 'px';
            slider.style.width = btnRect.width + 'px';

            const data = tariffData[tariff];

            // Fade out animation - joyida xira bo'ladi
            const header = document.querySelector('.payment-header');
            const featuresList = document.getElementById('featuresList');
            
            header.style.opacity = '0';
            featuresList.style.opacity = '0';

            // Update content after fade out
            setTimeout(() => {
                document.getElementById('tariffTitle').textContent = data.title;
                document.getElementById('tariffDesc').textContent = data.desc;
                updateActionButton();

                // Update features
                featuresList.innerHTML = data.features.map(feature => `
                    <div class="feature-item">
                        <div class="feature-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                        <div class="feature-text">${feature}</div>
                    </div>
                `).join('');

                // Fade in animation - joyida to'q bo'ladi
                setTimeout(() => {
                    header.style.opacity = '1';
                    featuresList.style.opacity = '1';
                }, 50);
            }, 200);

            // Update bottom sheet prices
            updateSheetPrices();

            // Agar obuna holati ma'lum bo'lsa, lock holatini yangilash
            if (window.__USER_TARIFF_CODE__) {
                updateLockByTariff(window.__USER_TARIFF_CODE__);
            }
        }

        // Initialize slider position on page load
        window.addEventListener('DOMContentLoaded', () => {
            const selectedBtn = document.querySelector('.price-btn.selected');
            const slider = document.getElementById('priceSlider');
            const btnRect = selectedBtn.getBoundingClientRect();
            const wrapperRect = selectedBtn.parentElement.getBoundingClientRect();
            const offsetLeft = btnRect.left - wrapperRect.left;
            
            slider.style.left = offsetLeft + 'px';
            slider.style.width = btnRect.width + 'px';
            
            // Boshlang'ich narxlarni yangilash
            updateActionButton();
            updateSheetPrices();

            // Obuna holatini tekshirish va lock holatini qo'llash
            checkSubscriptionAndLock();
        });

        function updateSheetPrices() {
            const data = tariffData[currentTariff];
            const monthly = data.monthly;
            const yearly = monthly * 12 * 0.9; // 10% discount (12 oy uchun)

            document.getElementById('price1Month').textContent = `${monthly.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} so'm`;
            document.getElementById('price12Month').textContent = `${Math.round(yearly).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} so'm`;
        }

        function updateActionButton() {
            const data = tariffData[currentTariff];
            const price = currentDuration === 1 
                ? data.monthly 
                : Math.round(data.monthly * 12 * 0.9);
            document.getElementById('actionBtnText').textContent = `${price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} so'm evaziga yangilanish`;
        }

        function openBottomSheet() {
            hapticFeedback();
            updateSheetPrices();
            document.getElementById('bottomSheetOverlay').classList.add('active');
            document.getElementById('bottomSheet').classList.add('active');
        }

        function closeBottomSheet() {
            hapticFeedback();
            document.getElementById('bottomSheetOverlay').classList.remove('active');
            document.getElementById('bottomSheet').classList.remove('active');
        }

        function selectDuration(months, element) {
            hapticFeedback();
            currentDuration = months;

            document.querySelectorAll('.duration-card').forEach(card => {
                card.classList.remove('selected');
            });
            element.classList.add('selected');
            
            // Action button narxini yangilash
            updateActionButton();
        }

        function handleClickPayment() {
            hapticFeedback();
            processPayment();
        }

        // Subscription lock: agar PLUS/PRO aktiv bo'lsa — to'lashni bloklash
        async function checkSubscriptionAndLock() {
            try {
                let userId = null;
                if (tg?.initDataUnsafe?.user?.id) userId = tg.initDataUnsafe.user.id;
                else if (tg?.initData) {
                    const params = new URLSearchParams(tg.initData);
                    const userStr = params.get('user');
                    if (userStr) userId = JSON.parse(decodeURIComponent(userStr)).id;
                }
                if (!userId) return;
                const res = await fetch(`/api/user/tariff/${userId}`);
                const json = await res.json();
                const code = (json?.data?.tariff || 'Bepul').toString().toUpperCase();
                window.__USER_TARIFF_CODE__ = code;
                updateLockByTariff(code);
            } catch (e) {
                console.log('check sub error', e);
            }
        }

        // Foydalanuvchining aktiv tarifiga qarab lock holatini qo'llash
        function updateLockByTariff(userCode) {
            const banner = document.getElementById('successBanner');
            const openBtn = document.getElementById('openSheetBtn');
            const payBtn = document.getElementById('payBtn');
            const selectedCode = currentTariff.toUpperCase();
            // Faqat tanlangan tarif bilan bir xil bo'lsa bloklanadi
            const shouldBlock = (userCode === selectedCode);
            if (shouldBlock) {
                banner.textContent = `✅ Sizda allaqachon ${selectedCode} obuna faol. Qayta to'lov shart emas.`;
                banner.classList.add('show');
                openBtn?.setAttribute('disabled', 'true');
                payBtn?.setAttribute('disabled', 'true');
            } else {
                banner.classList.remove('show');
                openBtn?.removeAttribute('disabled');
                payBtn?.removeAttribute('disabled');
            }
        }

        async function processPayment() {
            hapticFeedback();

            // Telegram'dan user_id olish
            let userId = null;
            if (tg?.initDataUnsafe?.user?.id) {
                userId = tg.initDataUnsafe.user.id;
            } else if (tg?.initData) {
                // initData'dan user_id ni parse qilish
                try {
                    const params = new URLSearchParams(tg.initData);
                    const userStr = params.get('user');
                    if (userStr) {
                        const user = JSON.parse(decodeURIComponent(userStr));
                        userId = user.id;
                    }
                } catch (e) {
                    console.error('Error parsing initData:', e);
                }
            }

            if (!userId) {
                if (tg) {
                    tg.showAlert('❌ User ID topilmadi. Iltimos, Telegram orqali kirishingiz kerak.');
                } else {
                    alert('❌ User ID topilmadi');
                }
                return;
            }

            const data = tariffData[currentTariff];
            // 10% chegirma (12 oy uchun)
            const amount = currentDuration === 1 
                ? data.monthly 
                : Math.round(data.monthly * 12 * 0.9);

            try {
                // Form yaratish va POST qilish
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/payment';
                
                form.appendChild(createHiddenInput('user_id', userId));
                form.appendChild(createHiddenInput('tariff', currentTariff.toUpperCase()));
                form.appendChild(createHiddenInput('months', currentDuration.toString()));
                
                document.body.appendChild(form);
                form.submit();
                
            } catch (error) {
                console.error('Payment error:', error);
                if (tg) {
                    tg.showAlert('❌ To\'lovni amalga oshirishda xatolik');
                } else {
                    alert('❌ To\'lovni amalga oshirishda xatolik');
                }
            }
        }

        function createHiddenInput(name, value) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            return input;
        }
    </script>
</body>
</html>
