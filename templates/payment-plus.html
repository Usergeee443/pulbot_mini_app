<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balans AI - Plus paketlar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: #F7F8FA;
            color: #0F172A;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .page {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px 20px 120px;
        }
        .page-header {
            margin-bottom: 24px;
        }
        .page-header span {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 999px;
            background: #E0EDFF;
            color: #1D4ED8;
            font-size: 13px;
            font-weight: 600;
        }
        .page-header h1 {
            font-size: 28px;
            font-weight: 800;
            margin-top: 12px;
            margin-bottom: 10px;
            letter-spacing: -0.3px;
        }
        .page-header p {
            font-size: 15px;
            color: rgba(15, 23, 42, 0.65);
            line-height: 1.55;
            max-width: 360px;
        }
        .info-banner {
            display: none;
            margin-bottom: 20px;
            padding: 14px 16px;
            border-radius: 16px;
            background: #FDF6E8;
            color: #92400E;
            font-size: 14px;
            font-weight: 500;
        }
        .info-banner.show { display: block; }
        .subscription-card {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
            background: #ffffff;
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 20px;
            padding: 18px 20px;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.05);
        }
        .subscription-card.show { display: flex; }
        .subscription-status {
            font-size: 12px;
            font-weight: 700;
            color: #16A34A;
            letter-spacing: 0.4px;
            text-transform: uppercase;
        }
        .subscription-name {
            font-size: 20px;
            font-weight: 700;
            color: #0F172A;
            letter-spacing: -0.3px;
        }
        .subscription-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 14px;
            color: rgba(15, 23, 42, 0.65);
        }
        .subscription-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .subscription-label {
            font-weight: 600;
            color: rgba(15, 23, 42, 0.6);
        }
        .subscription-value {
            font-weight: 600;
            color: #0F172A;
        }
        .packages-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .package-card {
            background: white;
            border-radius: 24px;
            padding: 20px 18px 18px;
            border: 1px solid rgba(148, 163, 184, 0.18);
            box-shadow: 0 8px 16px rgba(15, 23, 42, 0.06);
            display: flex;
            flex-direction: column;
            gap: 14px;
            text-align: left;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            position: relative;
        }
        .package-card:active { transform: scale(0.99); }
        .package-card.selected {
            border-color: #2563EB;
            box-shadow: 0 12px 20px rgba(37, 99, 235, 0.18);
        }
        .package-badge {
            position: absolute;
            top: 18px;
            right: 18px;
            background: linear-gradient(120deg, #2563EB, #1D4ED8);
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 999px;
            letter-spacing: 0.3px;
        }
        .package-title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.2px;
        }
        .package-tagline {
            font-size: 15px;
            color: rgba(15, 23, 42, 0.65);
        }
        .package-metrics {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 6px;
        }
        .metric {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            color: rgba(15, 23, 42, 0.85);
        }
        .metric img {
            width: 20px;
            height: 20px;
        }
        .package-price {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.4px;
        }
        .package-active-label {
            display: none;
            font-size: 13px;
            font-weight: 600;
            color: #16A34A;
        }
        .package-card.active .package-active-label {
            display: block;
        }
        .page-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px 24px;
            background: linear-gradient(180deg, rgba(247, 248, 250, 0.1) 0%, rgba(247, 248, 250, 0.95) 35%, #F7F8FA 100%);
            backdrop-filter: saturate(180%) blur(18px);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .primary-btn {
            width: 100%;
            border: none;
            border-radius: 999px;
            background: black;
            color: white;
            font-size: 16px;
            font-weight: 600;
            padding: 16px;
            cursor: pointer;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .primary-btn:active { transform: scale(0.98); }
        .primary-btn[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .legal-text {
            text-align: center;
            font-size: 11px;
            color: rgba(15, 23, 42, 0.5);
            line-height: 1.4;
        }
        .legal-text a { color: inherit; text-decoration: underline; }
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
            font-size: 15px;
            color: rgba(15, 23, 42, 0.65);
            z-index: 1000;
        }
        .loading-overlay.hidden { display: none; }
        .loading-spinner {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 3px solid rgba(148, 163, 184, 0.35);
            border-top-color: #2563EB;
            animation: spin 0.9s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .blocked-view {
            display: none;
            height: 100%;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .blocked-card {
            background: white;
            border-radius: 28px;
            padding: 32px 28px;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
        }
        .blocked-icon {
            width: 68px;
            height: 68px;
            border-radius: 999px;
            background: #E0EDFF;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 18px;
        }
        .blocked-card h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .blocked-card p {
            font-size: 15px;
            color: rgba(15, 23, 42, 0.6);
            line-height: 1.5;
            margin-bottom: 24px;
        }
        .bottom-sheet-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.35);
            backdrop-filter: blur(4px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
            z-index: 1100;
        }
        .bottom-sheet-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        .bottom-sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: #FFFFFF;
            border-radius: 28px 28px 0 0;
            box-shadow: 0 -18px 42px rgba(15, 23, 42, 0.2);
            transform: translateY(100%);
            transition: transform 0.28s ease;
            z-index: 1200;
            padding: 20px 20px 30px;
            max-height: 85vh;
            overflow-y: auto;
        }
        .bottom-sheet.active {
            transform: translateY(0);
        }
        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 14px;
            margin-bottom: 18px;
        }
        .sheet-title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.3px;
            color: #0F172A;
        }
        .sheet-subtitle {
            margin-top: 4px;
            font-size: 14px;
            color: rgba(15, 23, 42, 0.6);
            line-height: 1.4;
        }
        .sheet-close {
            background: rgba(148, 163, 184, 0.15);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: rgba(15, 23, 42, 0.6);
            cursor: pointer;
        }
        .sheet-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }
        .sheet-section-title {
            font-size: 14px;
            font-weight: 600;
            color: rgba(15, 23, 42, 0.55);
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }
        .sheet-package-stats {
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: rgba(37, 99, 235, 0.04);
            border: 1px solid rgba(37, 99, 235, 0.12);
            padding: 12px 14px;
            border-radius: 16px;
            font-size: 14px;
            color: rgba(15, 23, 42, 0.7);
        }
        .sheet-package-stats strong {
            color: #0F172A;
        }
        .promo-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .promo-input-group input {
            flex: 1;
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 14px;
            padding: 12px 14px;
            font-size: 15px;
            background: #F8FAFC;
        }
        .promo-input-group button {
            border: none;
            background: #1D4ED8;
            color: white;
            font-weight: 600;
            font-size: 14px;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .promo-input-group button:active {
            transform: scale(0.98);
        }
        .promo-input-group button[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .promo-feedback {
            font-size: 13px;
            min-height: 16px;
            color: rgba(15, 23, 42, 0.6);
        }
        .promo-feedback.error {
            color: #DC2626;
        }
        .promo-feedback.success {
            color: #16A34A;
        }
        .promo-remove-btn {
            align-self: flex-start;
            background: none;
            border: none;
            color: rgba(15, 23, 42, 0.6);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }
        .payment-methods {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .payment-method-card {
            flex: 1 1 calc(50% - 10px);
            min-width: 140px;
            background: #F8FAFC;
            border: 1.5px solid transparent;
            border-radius: 16px;
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
            transition: border-color 0.2s ease, background 0.2s ease, transform 0.2s ease;
        }
        .payment-method-card.active {
            border-color: #1D4ED8;
            background: rgba(29, 78, 216, 0.08);
        }
        .payment-method-card[data-available="false"] {
            opacity: 0.55;
        }
        .payment-method-card:active {
            transform: scale(0.98);
        }
        .payment-method-name {
            font-size: 15px;
            font-weight: 600;
            color: #0F172A;
        }
        .payment-method-description {
            font-size: 12px;
            color: rgba(15, 23, 42, 0.55);
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            color: rgba(15, 23, 42, 0.75);
        }
        .summary-row + .summary-row {
            margin-top: 6px;
        }
        .summary-row.discount {
            color: #DC2626;
        }
        .summary-row.total {
            font-size: 18px;
            font-weight: 700;
            color: #0F172A;
            margin-top: 4px;
        }
        .sheet-action-btn {
            width: 100%;
            background: #111827;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 999px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-top: 12px;
        }
        .sheet-action-btn:active {
            transform: scale(0.98);
        }
        .sheet-action-btn[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <span>Ma'lumotlar yuklanmoqda...</span>
    </div>

    <section class="page" id="content" style="visibility:hidden;">
        <header class="page-header">
            <span>Plus paketlar</span>
            <h1>Foydalanish hajmingizni tanlang</h1>
            <p>Matn va ovozli kiritish limitini o'zingizga mos ravishda tanlang. Qolgan barcha imkoniyatлар cheksiz.</p>
        </header>

        <div class="info-banner" id="infoBanner"></div>

        <div class="subscription-card" id="subscriptionInfo">
            <div class="subscription-status" id="subscriptionStatus">Faol paket</div>
            <div class="subscription-name" id="subscriptionName">Plus</div>
            <div class="subscription-meta">
                <span><span class="subscription-label">Muddati:</span> <span class="subscription-value" id="subscriptionExpiry">-</span></span>
                <span><span class="subscription-label">Limitlar:</span> <span class="subscription-value" id="subscriptionLimits">-</span></span>
            </div>
        </div>

        <div class="packages-grid" id="packagesGrid">
            {% for package in plus_packages %}
            <button class="package-card" data-code="{{ package.code }}" data-price="{{ package.price }}" data-text="{{ package.text_limit }}" data-voice="{{ package.voice_limit }}">
                {% if package.badge %}
                <span class="package-badge">{{ package.badge }}</span>
                {% endif %}
                <div class="package-title">{{ package.title }}</div>
                <div class="package-tagline">{{ package.tagline }}</div>
                <div class="package-metrics">
                    <div class="metric"><img src="/static/icons/verify.svg" alt=""> <span>{{ package.text_limit }} ta matn</span></div>
                    <div class="metric"><img src="/static/icons/verify.svg" alt=""> <span>{{ package.voice_limit }} ta ovoz</span></div>
                    <div class="metric"><img src="/static/icons/verify.svg" alt=""> <span>Boshqa funksiyalar cheksiz</span></div>
                </div>
                <div class="package-price">{{ '{:,}'.format(package.price).replace(',', ' ') }} so'm</div>
                <div class="package-active-label">Aktiv paket</div>
            </button>
            {% endfor %}
        </div>
    </section>

    <section class="blocked-view" id="blockedView">
        <div class="blocked-card">
            <div class="blocked-icon">
                <img src="/static/icons/verify.svg" alt="" style="width:28px;height:28px;">
            </div>
            <h2>Max obuna allaqachon faol</h2>
            <p>Hozirda sizda eng yuqori tarif ishga tushgan. Barcha imkoniyatlar ochiq, qo'shimcha paket sotib olish shart emas.</p>
            <button class="primary-btn" id="blockedCloseBtn">Asosiy menyuga qaytish</button>
        </div>
    </section>

    <footer class="page-footer" id="footer" style="visibility:hidden;">
        <button class="primary-btn" id="purchaseBtn" disabled>Paketni tanlang</button>
        <p class="legal-text">Sotib olish orqali <a href="/terms">foydalanish shartlari</a> va <a href="/privacy">maxfiylik siyosati</a>ga rozilik bildirasiz.</p>
    </footer>

    <div class="bottom-sheet-overlay" id="checkoutOverlay"></div>
    <div class="bottom-sheet" id="checkoutSheet">
        <div class="sheet-header">
            <div>
                <div class="sheet-title" id="checkoutTitle">Plus paket</div>
                <div class="sheet-subtitle" id="checkoutTagline"></div>
            </div>
            <button class="sheet-close" id="checkoutCloseBtn">✕</button>
        </div>

        <div class="sheet-section">
            <div class="sheet-section-title">Tanlangan paket</div>
            <div class="sheet-package-stats" id="checkoutLimits">
                <span>Matn limiti: <strong>-</strong></span>
                <span>Ovoz limiti: <strong>-</strong></span>
            </div>
        </div>

        <div class="sheet-section">
            <div class="sheet-section-title">Promokod</div>
            <div class="promo-input-group">
                <input type="text" id="promoInput" placeholder="Masalan, 50FRIEND50" autocomplete="off" inputmode="text">
                <button id="promoApplyBtn">Qo'llash</button>
            </div>
            <div class="promo-feedback" id="promoFeedback"></div>
            <button class="promo-remove-btn" id="promoRemoveBtn" style="display:none;">Promokodni olib tashlash</button>
        </div>

        <div class="sheet-section">
            <div class="sheet-section-title">To'lov usuli</div>
            <div class="payment-methods">
                <button class="payment-method-card active" data-method="click" data-available="true">
                    <span class="payment-method-name">Click</span>
                    <span class="payment-method-description">Bank karta</span>
                </button>
                <button class="payment-method-card" data-method="payme" data-available="false">
                    <span class="payment-method-name">Payme</span>
                    <span class="payment-method-description">Tez orada</span>
                </button>
                <button class="payment-method-card" data-method="uzum" data-available="false">
                    <span class="payment-method-name">Uzum Pay</span>
                    <span class="payment-method-description">Tez orada</span>
                </button>
                <button class="payment-method-card" data-method="other" data-available="false">
                    <span class="payment-method-name">Boshqa</span>
                    <span class="payment-method-description">Tez orada</span>
                </button>
            </div>
        </div>

        <div class="sheet-section">
            <div class="sheet-section-title">To'lov xulosasi</div>
            <div class="summary-row">
                <span>Asl narx</span>
                <span id="checkoutOriginalPrice">-</span>
            </div>
            <div class="summary-row discount" id="checkoutDiscountRow" style="display:none;">
                <span>Chegirma</span>
                <span id="checkoutDiscountValue">-</span>
            </div>
            <div class="summary-row total">
                <span>To'lov summasi</span>
                <span id="checkoutFinalPrice">-</span>
            </div>
        </div>

        <button class="sheet-action-btn" id="checkoutPayBtn">To'lash</button>
    </div>

    <script>
        (function () {
            const tg = window.Telegram?.WebApp;
            if (tg) {
                tg.ready();
                tg.expand();
                tg.disableVerticalSwipes();
            }

            const elements = {
                packages: Array.from(document.querySelectorAll('.package-card')),
                purchaseBtn: document.getElementById('purchaseBtn'),
                infoBanner: document.getElementById('infoBanner'),
                subscriptionInfo: document.getElementById('subscriptionInfo'),
                subscriptionStatus: document.getElementById('subscriptionStatus'),
                subscriptionName: document.getElementById('subscriptionName'),
                subscriptionExpiry: document.getElementById('subscriptionExpiry'),
                subscriptionLimits: document.getElementById('subscriptionLimits'),
                loadingOverlay: document.getElementById('loadingOverlay'),
                blockedView: document.getElementById('blockedView'),
                content: document.getElementById('content'),
                footer: document.getElementById('footer'),
                blockedCloseBtn: document.getElementById('blockedCloseBtn'),
                checkoutOverlay: document.getElementById('checkoutOverlay'),
                checkoutSheet: document.getElementById('checkoutSheet'),
                checkoutCloseBtn: document.getElementById('checkoutCloseBtn'),
                checkoutTitle: document.getElementById('checkoutTitle'),
                checkoutTagline: document.getElementById('checkoutTagline'),
                checkoutLimits: document.getElementById('checkoutLimits'),
                checkoutOriginalPrice: document.getElementById('checkoutOriginalPrice'),
                checkoutDiscountRow: document.getElementById('checkoutDiscountRow'),
                checkoutDiscountValue: document.getElementById('checkoutDiscountValue'),
                checkoutFinalPrice: document.getElementById('checkoutFinalPrice'),
                checkoutPayBtn: document.getElementById('checkoutPayBtn'),
                promoInput: document.getElementById('promoInput'),
                promoApplyBtn: document.getElementById('promoApplyBtn'),
                promoFeedback: document.getElementById('promoFeedback'),
                promoRemoveBtn: document.getElementById('promoRemoveBtn'),
                paymentMethodCards: Array.from(document.querySelectorAll('.payment-method-card')),
            };

            const state = {
                userId: null,
                selectedPackage: null,
                currentPackageCode: null,
                currentTariff: null,
                currentPackageMeta: null,
                currentExpiry: null,
                appliedPromo: null,
                paymentMethod: 'click',
            };

            function haptic(type = 'light') {
                if (tg?.HapticFeedback?.impactOccurred) {
                    tg.HapticFeedback.impactOccurred(type);
                }
            }

            function formatPrice(amount) {
                const numeric = Number(amount) || 0;
                return numeric.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            }

            function parsePrice(value) {
                const parsed = parseInt(value, 10);
                return Number.isFinite(parsed) ? parsed : 0;
            }

            function hideLoading() {
                elements.loadingOverlay.classList.add('hidden');
                elements.content.style.visibility = 'visible';
                elements.footer.style.visibility = 'visible';
            }

            function showBanner(text) {
                if (!elements.infoBanner) return;
                elements.infoBanner.textContent = text;
                elements.infoBanner.classList.add('show');
            }

            function hideBanner() {
                if (!elements.infoBanner) return;
                elements.infoBanner.classList.remove('show');
            }

            function getBaseAmount() {
                if (!state.selectedPackage) return 0;
                return parsePrice(state.selectedPackage.dataset.price);
            }

            function updateButton() {
                const btn = elements.purchaseBtn;
                if (!btn) return;
                if (!state.selectedPackage) {
                    btn.textContent = 'Paketni tanlang';
                    btn.setAttribute('disabled', 'true');
                    return;
                }
                const baseAmount = getBaseAmount();
                const effectiveAmount = state.appliedPromo ? state.appliedPromo.final_amount : baseAmount;
                let label = `${formatPrice(effectiveAmount)} so'mga sotib olish`;
                if (state.selectedPackage.dataset.code === state.currentPackageCode) {
                    label = `${formatPrice(effectiveAmount)} so'mga limitni yangilash`;
                }
                btn.textContent = label;
                btn.removeAttribute('disabled');
            }

            function markActivePackages() {
                elements.packages.forEach((card) => {
                    if (card.dataset.code === state.currentPackageCode) {
                        card.classList.add('active');
                    } else {
                        card.classList.remove('active');
                    }
                });
            }

            function clearPromo(options = {}) {
                const keepInput = options.keepInput || false;
                state.appliedPromo = null;
                if (!keepInput && elements.promoInput) {
                    elements.promoInput.value = '';
                }
                if (elements.promoFeedback) {
                    elements.promoFeedback.textContent = '';
                    elements.promoFeedback.className = 'promo-feedback';
                }
                if (elements.promoRemoveBtn) {
                    elements.promoRemoveBtn.style.display = 'none';
                }
                if (elements.checkoutDiscountRow) {
                    elements.checkoutDiscountRow.style.display = 'none';
                }
                renderCheckoutSummary();
                updateButton();
            }

            function selectPackage(card, options = {}) {
                if (!card) return;
                const allowReselect = options.allowReselect || false;
                const skipPromoReset = options.skipPromoReset || false;
                const silent = options.silent || false;
                const skipBanner = options.skipBanner || false;
                if (!allowReselect && card === state.selectedPackage) {
                    return;
                }
                elements.packages.forEach(pkg => pkg.classList.remove('selected'));
                card.classList.add('selected');
                state.selectedPackage = card;
                if (!skipBanner) {
                    hideBanner();
                    if (card.dataset.code === state.currentPackageCode) {
                        showBanner('Bu paket sizda allaqachon faol. Sotib olsangiz limitlar yangilanadi.');
                    }
                }
                if (!skipPromoReset) {
                    clearPromo();
                } else {
                    renderCheckoutSummary();
                    updateButton();
                }
                if (!silent) {
                    haptic();
                }
            }

            function renderCheckoutSummary() {
                if (!state.selectedPackage) return;
                const titleEl = state.selectedPackage.querySelector('.package-title');
                const taglineEl = state.selectedPackage.querySelector('.package-tagline');
                const baseAmount = getBaseAmount();
                const discountAmount = state.appliedPromo ? state.appliedPromo.discount_amount : 0;
                const finalAmount = state.appliedPromo ? state.appliedPromo.final_amount : baseAmount;

                if (elements.checkoutTitle) {
                    elements.checkoutTitle.textContent = titleEl ? titleEl.textContent : 'Plus paket';
                }
                if (elements.checkoutTagline) {
                    elements.checkoutTagline.textContent = taglineEl ? taglineEl.textContent : '';
                }
                if (elements.checkoutLimits) {
                    const textLimitRaw = state.selectedPackage.dataset.text;
                    const voiceLimitRaw = state.selectedPackage.dataset.voice;
                    const formatLimit = (value) => {
                        if (value === undefined || value === null || value === '') return '-';
                        return value === '-1' ? 'Cheksiz' : value;
                    };
                    const textLimit = formatLimit(textLimitRaw);
                    const voiceLimit = formatLimit(voiceLimitRaw);
                    elements.checkoutLimits.innerHTML = `
                        <span>Matn limiti: <strong>${textLimit}</strong></span>
                        <span>Ovoz limiti: <strong>${voiceLimit}</strong></span>
                    `;
                }
                if (elements.checkoutOriginalPrice) {
                    elements.checkoutOriginalPrice.textContent = `${formatPrice(baseAmount)} so'm`;
                }
                if (elements.checkoutDiscountRow) {
                    if (discountAmount > 0) {
                        elements.checkoutDiscountRow.style.display = 'flex';
                        if (elements.checkoutDiscountValue) {
                            elements.checkoutDiscountValue.textContent = `- ${formatPrice(discountAmount)} so'm`;
                        }
                    } else {
                        elements.checkoutDiscountRow.style.display = 'none';
                    }
                }
                if (elements.checkoutFinalPrice) {
                    elements.checkoutFinalPrice.textContent = `${formatPrice(finalAmount)} so'm`;
                }
                if (elements.checkoutPayBtn) {
                    elements.checkoutPayBtn.textContent = `${formatPrice(finalAmount)} so'mga to'lash`;
                }
            }

            function openCheckoutSheet() {
                if (!state.selectedPackage) return;
                haptic('medium');
                renderCheckoutSummary();
                elements.checkoutOverlay?.classList.add('active');
                elements.checkoutSheet?.classList.add('active');
            }

            function closeCheckoutSheet() {
                elements.checkoutOverlay?.classList.remove('active');
                elements.checkoutSheet?.classList.remove('active');
            }

            function showPromoFeedback(message, isError) {
                if (!elements.promoFeedback) return;
                elements.promoFeedback.textContent = message;
                elements.promoFeedback.className = 'promo-feedback';
                if (message) {
                    elements.promoFeedback.classList.add(isError ? 'error' : 'success');
                }
            }

            async function applyPromo() {
                if (!state.selectedPackage || !elements.promoInput || !elements.promoApplyBtn) return;
                const code = elements.promoInput.value.trim();
                if (!code) {
                    showPromoFeedback('Iltimos, promokodni kiriting.', true);
                    haptic();
                    return;
                }
                const baseAmount = getBaseAmount();
                if (!baseAmount) {
                    showPromoFeedback('Paket narxi aniqlanmadi.', true);
                    return;
                }

                elements.promoApplyBtn.disabled = true;
                elements.promoApplyBtn.textContent = 'Tekshirilmoqda...';
                showPromoFeedback('', false);

                try {
                    const response = await fetch('/api/promocode/validate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            code,
                            plan_type: 'PLUS',
                            amount: baseAmount,
                        }),
                    });
                    const json = await response.json();
                    if (!response.ok || !json?.success) {
                        throw new Error(json?.message || 'Promokod topilmadi.');
                    }
                    const data = json.data || {};
                    state.appliedPromo = {
                        code: data.code,
                        discount_percent: data.discount_percent,
                        discount_amount: data.discount_amount,
                        final_amount: data.final_amount,
                    };
                    if (elements.promoRemoveBtn) {
                        elements.promoRemoveBtn.style.display = 'inline-flex';
                    }
                    showPromoFeedback(`${state.appliedPromo.discount_percent}% chegirma qo'llandi.`, false);
                    renderCheckoutSummary();
                    updateButton();
                    haptic('medium');
                } catch (err) {
                    state.appliedPromo = null;
                    showPromoFeedback(err.message || 'Promokodni qo\'llab bo\'lmadi.', true);
                    if (elements.promoRemoveBtn) {
                        elements.promoRemoveBtn.style.display = 'none';
                    }
                    renderCheckoutSummary();
                    updateButton();
                } finally {
                    elements.promoApplyBtn.disabled = false;
                    elements.promoApplyBtn.textContent = "Qo'llash";
                }
            }

            function removePromo() {
                clearPromo({ keepInput: true });
                if (elements.promoInput) {
                    elements.promoInput.focus();
                }
                haptic();
            }

            function selectPaymentMethod(card) {
                if (!card) return;
                const method = card.dataset.method || 'click';
                const available = card.dataset.available !== 'false';
                if (!available) {
                    if (tg?.showAlert) {
                        tg.showAlert('Bu to\'lov usuli tez orada ishga tushadi.');
                    } else {
                        alert('Bu to\'lov usuli tez orada ishga tushadi.');
                    }
                    return;
                }
                state.paymentMethod = method;
                elements.paymentMethodCards.forEach(item => {
                    item.classList.toggle('active', item === card);
                });
                haptic();
            }

            function createHiddenInput(name, value) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = value;
                return input;
            }

            function submitPayment() {
                if (!state.selectedPackage || !state.userId) return;
                if (state.paymentMethod !== 'click') {
                    if (tg?.showAlert) {
                        tg.showAlert('Bu to\'lov usuli tez orada ishga tushadi.');
                    } else {
                        alert('Bu to\'lov usuli tez orada ishga tushadi.');
                    }
                    return;
                }
                try {
                    haptic('medium');
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/payment-plus';
                    form.appendChild(createHiddenInput('user_id', state.userId));
                    form.appendChild(createHiddenInput('package_code', state.selectedPackage.dataset.code));
                    form.appendChild(createHiddenInput('payment_method', state.paymentMethod));
                    if (state.appliedPromo?.code) {
                        form.appendChild(createHiddenInput('promo_code', state.appliedPromo.code));
                    }
                    document.body.appendChild(form);
                    form.submit();
                } catch (err) {
                    console.error('Checkout error:', err);
                    if (tg?.showAlert) {
                        tg.showAlert('To\'lovni boshlashda xatolik yuz berdi.');
                    } else {
                        alert('To\'lovni boshlashda xatolik yuz berdi.');
                    }
                }
            }

            elements.packages.forEach(card => {
                card.addEventListener('click', () => selectPackage(card));
            });

            elements.purchaseBtn?.addEventListener('click', () => {
                if (!state.selectedPackage) return;
                if (!state.userId) {
                    if (tg?.showAlert) {
                        tg.showAlert('Telegram foydalanuvchisini aniqlab bo\'lmadi.');
                    } else {
                        alert('Telegram foydalanuvchisini aniqlab bo\'lmadi.');
                    }
                    return;
                }
                openCheckoutSheet();
            });

            elements.checkoutOverlay?.addEventListener('click', closeCheckoutSheet);
            elements.checkoutCloseBtn?.addEventListener('click', closeCheckoutSheet);
            elements.checkoutPayBtn?.addEventListener('click', submitPayment);
            elements.promoApplyBtn?.addEventListener('click', applyPromo);
            elements.promoRemoveBtn?.addEventListener('click', removePromo);

            elements.paymentMethodCards.forEach(card => {
                card.addEventListener('click', () => selectPaymentMethod(card));
            });

            if (elements.blockedCloseBtn) {
                elements.blockedCloseBtn.addEventListener('click', () => {
                    if (tg) {
                        tg.close();
                    } else {
                        window.close();
                    }
                });
            }

            async function resolveUserId() {
                if (tg?.initDataUnsafe?.user?.id) {
                    return tg.initDataUnsafe.user.id;
                }
                if (tg?.initData) {
                    try {
                        const params = new URLSearchParams(tg.initData);
                        const userStr = params.get('user');
                        if (userStr) {
                            const parsed = JSON.parse(decodeURIComponent(userStr));
                            if (parsed?.id) return parsed.id;
                        }
                    } catch (err) {
                        console.error('initData parse error:', err);
                    }
                }
                return null;
            }

            function showBlockedView(tariffCode) {
                if (!elements.blockedView) return;
                elements.content.style.display = 'none';
                elements.footer.style.display = 'none';
                elements.blockedView.style.display = 'flex';
                const title = elements.blockedView.querySelector('h2');
                const text = elements.blockedView.querySelector('p');
                if (!title || !text) return;
                if (tariffCode === 'PRO' || tariffCode === 'MAX') {
                    title.textContent = 'Max obuna allaqachon faol';
                    text.textContent = 'Sizda eng yuqori tarif ishga tushgan. Qo\'shimcha paket sotib olish mavjud imkoniyatlarni o\'zgartirmaydi.';
                }
            }

            function renderSubscriptionInfo() {
                if (!elements.subscriptionInfo) return;
                elements.subscriptionInfo.classList.add('show');
                elements.subscriptionStatus.textContent = 'Faol paket';
                const title = state.currentPackageMeta?.title || 'Plus';
                elements.subscriptionName.textContent = title;
                const textLimit = state.currentPackageMeta?.text_limit;
                const voiceLimit = state.currentPackageMeta?.voice_limit;
                if (textLimit && voiceLimit) {
                    elements.subscriptionLimits.textContent = `${textLimit} ta matn / ${voiceLimit} ta ovoz`;
                } else {
                    elements.subscriptionLimits.textContent = 'Limitlar mavjud';
                }
                if (state.currentExpiry) {
                    try {
                        const date = new Date(state.currentExpiry);
                        elements.subscriptionExpiry.textContent = date.toLocaleDateString('uz-UZ', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    } catch (_) {
                        elements.subscriptionExpiry.textContent = state.currentExpiry;
                    }
                } else {
                    elements.subscriptionExpiry.textContent = 'Avtomatik yangilanadi';
                }
                showBanner('Faol paket maʼlumotlari yangilandi.');
            }

            async function loadTariff() {
                try {
                    const response = await fetch(`/api/user/tariff/${state.userId}`);
                    if (!response.ok) return true;
                    const json = await response.json();
                    state.currentTariff = (json?.data?.tariff || 'Bepul').toString().toUpperCase();
                    state.currentPackageCode = (json?.data?.package?.code || '').toString().toUpperCase();
                    state.currentPackageMeta = json?.data?.package || null;
                    state.currentExpiry = json?.data?.expires_at || null;
                    if (elements.subscriptionInfo) {
                        elements.subscriptionInfo.classList.remove('show');
                    }
                    if (state.currentTariff === 'PRO' || state.currentTariff === 'MAX') {
                        showBlockedView(state.currentTariff);
                        return false;
                    }
                    if (state.currentTariff === 'PLUS') {
                        renderSubscriptionInfo();
                    }
                    markActivePackages();
                    if (state.currentPackageCode) {
                        const activeCard = elements.packages.find(card => card.dataset.code === state.currentPackageCode);
                        if (activeCard) {
                            selectPackage(activeCard, { silent: true, skipPromoReset: true });
                        }
                    }
                    return true;
                } catch (err) {
                    console.error('Tariff load error:', err);
                    return true;
                }
            }

            async function init() {
                state.userId = await resolveUserId();
                if (!state.userId) {
                    hideLoading();
                    if (tg?.showAlert) {
                        tg.showAlert('Telegram foydalanuvchisini aniqlab bo\'lmadi. Iltimos, mini ilovani Telegram orqali oching.');
                    }
                    return;
                }
                const proceed = await loadTariff();
                hideLoading();
                if (proceed === false) {
                    return;
                }
                if (!state.selectedPackage && elements.packages.length) {
                    selectPackage(elements.packages[0], { silent: true });
                }
                updateButton();
            }

            init();
        })();
    </script>
</body>
</html>
